<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>3D æŠ½å¡ Demo - æ–ä¸€æ–ç‰ˆ</title>
<style>
html, body {
  margin:0;
  padding:0;
  height:100%;
  font-family:Arial,sans-serif;
  overflow:hidden;
  background:#111;
  touch-action: manipulation;
}

#mobileScreen{
  width:100vw;
  height:calc(var(--vh,1vh)*100);
  background:url('13.jpg') no-repeat center center;
  background-size:cover;
  position:relative;
  overflow:hidden;
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  box-sizing: border-box;
}

#cardContainer{
  width:100%;
  height:100%;
  perspective:1000px;
  position:relative;
}

.cardGroup{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) rotateY(0deg);
  transform-style:preserve-3d;
  will-change:transform;
}

.card{
  width:20vw;
  height:calc(20vw*800/600);
  position:absolute;
  top:50%;
  left:50%;
  background-size:cover;
  background-position:center;
  border-radius:12px;
  transform-style:preserve-3d;
  transition:opacity 1s, transform 1s;
  background-color:red;
}

.centerCard{
  width:80vw;
  height:calc(80vw*800/600);
  position:absolute;
  top:50%;
  left:50%;
  background-size:cover;
  background-position:center;
  border-radius:16px;
  box-shadow:0 0 25px gold,0 0 50px yellow;
  z-index:10;
  opacity:0;
  transform:translate(-50%,-50%) scale(0.5);
  transition:opacity 1s, transform 1s;
}

.centerCard.show{
  opacity:1;
  transform:translate(-50%,-50%) scale(1);
}

.star{
  position:absolute;
  width:20px;
  height:20px;
  background:white;
  border-radius:50%;
  pointer-events:none;
  animation:flyStar 1.8s ease-out forwards;
}

@keyframes flyStar{to{
  transform:translate(var(--x),var(--y)) scale(0);
  opacity:0;}}

.drawButton{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width:80%;
  max-width:300px;
  height:50px;
  background:transparent;
  border:none;
  cursor:pointer;
  z-index:9999;
  bottom: calc(5% + env(safe-area-inset-bottom));
}

#overlay{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0);
  pointer-events:none;
  z-index:1;
}

.cardGroup,.centerCard{
  position:absolute;
  z-index:10;
}

.viewButton{
  position:absolute;
  bottom: calc(2% + env(safe-area-inset-bottom));
  right: calc(2% + env(safe-area-inset-right));
  padding:10px 15px;
  font-size:16px;
  border:none;
  background:rgba(255,215,0,0.8);
  color:black;
  border-radius:8px;
  cursor:pointer;
  z-index:9999;
}

#myCardsModal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  z-index:10000;
  color:white;
  overflow-y:auto;
  text-align:center;
  padding-top:50px;
}

#myCardsContent{
  width:95%;
  margin:0 auto;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:20px;
  padding-bottom: 20px;
}

.fullSet {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  width: 100%;
  max-width: 600px;
  margin: 0 auto;
}

.fullSetRow {
  display: grid;
  gap: 10px;
  width: 100%;
}

.fullSetRow:first-child {
  grid-template-columns: repeat(4, 1fr);
}

.fullSetRow:last-child {
  grid-template-columns: repeat(3, 1fr);
  max-width: 75%;
  margin: 0 auto;
}

.zeroCards {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  width: 100%;
  max-width: 600px;
  margin: 0 auto;
}

.fullSetRow img, .zeroCards img {
  width: 100%;
  aspect-ratio: 3/4;
  border-radius: 8px;
  box-shadow: 0 0 10px gold;
  cursor: pointer;
  object-fit: cover;
}

.close-button{
  position:absolute;
  top:15px;
  right:15px;
  width:40px;
  height:40px;
  background:rgba(255,255,255,0.2);
  border-radius:50%;
  border:none;
  color:white;
  font-size:24px;
  font-weight:bold;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10001;
}

.close-button:hover{background:rgba(255,255,255,0.3);}

#redeemModal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.7);
  z-index:20000;
  align-items:center;
  justify-content:center;
}

#redeemModalContent{
  background:white;
  color:black;
  padding:20px;
  border-radius:12px;
  width:80%;
  max-width:400px;
  text-align:center;
}

#redeemModalContent button{
  margin:10px;
  padding:10px 20px;
  font-size:18px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

#confirmBtn{background:#ffcc00;}
#cancelBtn{background:#ccc;}

@media (max-width: 600px) {
  .fullSetRow, .zeroCards {
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }
  
  #myCardsContent {
    width: 90%;
  }
  
  .viewButton {
    padding: 8px 12px;
    font-size: 14px;
  }
  
  .drawButton {
    height: 45px;
    bottom: calc(7% + env(safe-area-inset-bottom));
  }
}
</style>
</head>
<body>
<div id="mobileScreen">
  <div id="cardContainer">
    <div class="cardGroup" id="cardGroup"></div>
    <div id="overlay"></div>
  </div>
  <!-- é€æ˜æŒ‰éˆ•ï¼Œç”¨ä¾†èªè­‰æ‰‹æ–æˆæ¬Š -->
  <button class="drawButton" id="enableShake"></button>
  <button class="viewButton" onclick="showMyCards()">æŸ¥çœ‹æˆ‘çš„å¡ç‰‡</button>
</div>

<div id="myCardsModal">
  <div id="myCardsContent">
    <button class="close-button" onclick="closeMyCardsModal()">Ã—</button>
  </div>
</div>

<div id="redeemModal">
  <div id="redeemModalContent">
    <p id="redeemText" style="font-size:20px;line-height:1.5;"></p>
    <button id="confirmBtn" onclick="confirmRedeem(event)">ç¢ºèªå…Œæ›</button>
    <button id="cancelBtn" onclick="closeRedeem()">å–æ¶ˆ</button>
  </div>
</div>

<script>
/* è¨­å®šè¦–çª—é«˜åº¦è®Šæ•¸ */
function setFullHeight(){
  document.documentElement.style.setProperty('--vh',window.innerHeight*0.01+'px');
}
window.addEventListener('resize',setFullHeight);
setFullHeight();

/* æŠ½å¡è³‡æ–™ */
const backImage='9.jpg';
const cardImages=['1.jpg','22.jpg','3.jpg','4.jpg','21.jpg','20.jpg','23.jpg'];
const cardActivities={'1.jpg':'å“ç‰Œç´€å¿µå°ç‰©','22.jpg':'è²·ä»»ä¸€é›è›‹ä»”é€1æ¯æ¢”æ˜¥é‡‘çƒé¾','3.jpg':'ç¾æŠ˜10å…ƒï¼ˆå¡”å¯ç³»åˆ—é™¤å¤–ï¼‰','4.jpg':'é‡‘æ¡”ç³»åˆ—æŠ˜5å…ƒ','21.jpg':'é»ä¸­æ¯å‡ç´šå¤§æ¯å…è²»','20.jpg':'é‡‘æ¡”ç³»åˆ—ç¾æŠ˜10å…ƒ','23.jpg':'ç¬¬äºŒæ¯10å¡Š'};
// å¡ç‰‡æ¬Šé‡è¨­å®šï¼ˆç¨€æœ‰å¡å¯è¨­å®šè¼ƒä½æ¬Šé‡ï¼‰
const cardPool = [
  {img:'1.jpg', weight: 30},  // æ™®é€šå¡
  {img:'22.jpg', weight: 30},
  {img:'3.jpg', weight: 30},
  {img:'4.jpg', weight: 30},
  {img:'21.jpg', weight: 30},
  {img:'20.jpg', weight: 30},
  {img:'23.jpg', weight: 10}   // ç¨€æœ‰å¡ï¼Œæ¬Šé‡ä½
];

function getDrawData() {
  let data = JSON.parse(localStorage.getItem('drawData')) || { lastDrawDate: null, drawCount:0, cards:[], totalDraws:0 };
  const today = new Date().toISOString().split('T')[0];
  if(data.lastDrawDate!==today){ data={ lastDrawDate:today, drawCount:0, cards:data.cards, totalDraws:data.totalDraws }; }
  return data;
}
function saveDrawData(data){ localStorage.setItem('drawData',JSON.stringify(data)); }

let rotateInterval=null;
let centerCardTimeout=null;
let currentCenterCard=null;

function resetDraw() {
  if(rotateInterval){ clearInterval(rotateInterval); rotateInterval=null; }
  if(centerCardTimeout){ clearTimeout(centerCardTimeout); centerCardTimeout=null; }
  if(currentCenterCard){ currentCenterCard.remove(); currentCenterCard=null; }
  document.getElementById("cardGroup").innerHTML="";
  document.getElementById("overlay").style.background="rgba(0,0,0,0)";
}

function drawCardByWeight(pool){
  let totalWeight = pool.reduce((sum, c) => sum + c.weight, 0);
  let rnd = Math.random() * totalWeight;
  for(let i=0;i<pool.length;i++){
    if(rnd < pool[i].weight) return pool[i].img;
    rnd -= pool[i].weight;
  }
}

/* æ ¸å¿ƒæŠ½å¡æµç¨‹ */
function startDraw() {
  let data = getDrawData();
  const maxDraws = 15; // æ¯æ—¥ä¸Šé™

  if (data.drawCount >= maxDraws) {
    alert("ğŸ‹ä»Šå¤©çš„æŠ½å¡èƒ½é‡æ­¸é›¶ï¼âš¡ï¸æ˜å¤©å†ä¾†ï¼");
    return;
  }

  resetDraw();
  const group = document.getElementById("cardGroup");
  const total = 7;
  let cards = [];
  for (let i = 0; i < total; i++) {
    const card = document.createElement("div");
    card.className = "card";
    card.style.backgroundImage = `url('${backImage}')`;
    const angle = (i / total) * 360;
    card.style.transform = `translate(-50%,-50%) rotateY(${angle}deg) translateZ(30vw)`;
    group.appendChild(card);
    cards.push(card);
  }

  let rotation = 0;
  rotateInterval = setInterval(() => {
    rotation += 1;
    group.style.transform = `translate(-50%,-50%) rotateY(${rotation}deg)`;
  }, 20);

  centerCardTimeout = setTimeout(() => {
    clearInterval(rotateInterval);
    rotateInterval = null;
    cards.forEach(c => c.style.opacity = 0);

    // ===== ä¿åº•æŠ½å¡é‚è¼¯ =====
    const remainingDraws = maxDraws - data.drawCount;
    const drawnCards = data.cards;
    const missingCards = cardImages.filter(img => !drawnCards.includes(img));

    let chosenCard;
    if (remainingDraws <= missingCards.length) {
      // ä¿åº•ï¼šå¾ç¼ºå¡è£¡éš¨æ©ŸæŠ½ä¸€å¼µ
      const index = Math.floor(Math.random() * missingCards.length);
      chosenCard = missingCards[index];
    } else {
      // æ­£å¸¸æŠ½å¡
      chosenCard = drawCardByWeight(cardPool);
    }

    showCenterCard(chosenCard);

    data.drawCount++;
    data.totalDraws++;
    data.cards.push(chosenCard);
    data.lastDrawDate = new Date().toISOString().split('T')[0];
    saveDrawData(data);
  }, 3000);
}


function showCenterCard(imageUrl){
  const overlay=document.getElementById('overlay');
  overlay.style.background='rgba(0,0,0,0.4)';
  const container=document.getElementById("cardContainer");
  const centerCard=document.createElement("div");
  centerCard.className="centerCard";
  centerCard.style.backgroundImage=`url('${imageUrl}')`;
  container.appendChild(centerCard);
  currentCenterCard=centerCard;
  requestAnimationFrame(()=>centerCard.classList.add('show'));
  spawnStars(centerCard,20);
  setTimeout(()=>{ overlay.style.background='rgba(0,0,0,0)'; if(centerCard){ centerCard.remove(); currentCenterCard=null;} },5000);
}

function spawnStars(target,count){
  const rect=target.getBoundingClientRect();
  for(let i=0;i<count;i++){
    const star=document.createElement("div");
    star.className="star";
    star.style.left=`${rect.left+rect.width/2}px`;
    star.style.top=`${rect.top+rect.height/2}px`;
    const angle=Math.random()*2*Math.PI;
    const distance=80+Math.random()*100;
    star.style.setProperty("--x",`${Math.cos(angle)*distance}px`);
    star.style.setProperty("--y",`${Math.sin(angle)*distance}px`);
    document.body.appendChild(star);
    setTimeout(()=>star.remove(),1800);
  }
}

/* æˆ‘çš„å¡ç‰‡æ¨¡æ…‹ */
let redeemTarget=null;
function closeMyCardsModal(){document.getElementById('myCardsModal').style.display='none';}
function showMyCards(){
  const modal=document.getElementById('myCardsModal');
  const content=document.getElementById('myCardsContent');
  content.innerHTML=`<button class="close-button" onclick="closeMyCardsModal()">Ã—</button><h2>æˆ‘çš„å¡ç‰‡</h2>`;
  let data=getDrawData();
  let myCards=[...data.cards];
  let groupCount=0;

  while(cardImages.every(img=>myCards.includes(img))){
    groupCount++;
    content.innerHTML+=`<h3>ç¬¬ ${groupCount} çµ„å®Œæ•´ä¸ƒå¼µ ğŸ‰</h3>`;
    let fullSetHTML=`<div class="fullSet"><div class="fullSetRow">`;
    for(let i=0;i<4;i++){ fullSetHTML+=`<img src="${cardImages[i]}" alt="å¡ç‰‡">`; myCards.splice(myCards.indexOf(cardImages[i]),1);}
    fullSetHTML+=`</div><div class="fullSetRow">`;
    for(let i=4;i<7;i++){ fullSetHTML+=`<img src="${cardImages[i]}" alt="å¡ç‰‡">`; myCards.splice(myCards.indexOf(cardImages[i]),1);}
    fullSetHTML+=`</div></div>`;
    content.innerHTML+=fullSetHTML;
    content.innerHTML+=`<div style="margin:15px;"><button onclick="event.stopPropagation(); openRedeemModal('group',${groupCount})" style="padding:10px 20px;font-size:18px;border:none;border-radius:8px;background:#ff6600;color:white;cursor:pointer;">å…Œæ›ä¸€æ¯é£²å“</button></div>`;
  }

  if(myCards.length>0){
    content.innerHTML+="<h3>é›¶æ•£å¡ç‰‡</h3>";
    let zeroHTML=`<div class="zeroCards">`;
    myCards.forEach(img=>{zeroHTML+=`<img src="${img}" alt="å¡ç‰‡" onclick="event.stopPropagation(); openRedeemModal('single','${img}')">`;});
    zeroHTML+=`</div>`;
    content.innerHTML+=zeroHTML;
  }

  modal.style.display='flex';
}

/* å…Œæ›æ¨¡æ…‹ */
function openRedeemModal(type,target){
  redeemTarget={type,target};
  const modal=document.getElementById("redeemModal");
  const textEl=document.getElementById("redeemText");

  if(type==="single"){const activity=cardActivities[target]||"å…Œæ›æ´»å‹•"; textEl.innerText=`å¡ç‰‡æ´»å‹•ï¼š${activity}\nç¢ºèªå…Œæ›é€™å¼µå¡ç‰‡å—ï¼Ÿ`;}
  else if(type==="group"){textEl.innerText=`ç¢ºèªè¦å…Œæ›ç¬¬ ${target} çµ„å®Œæ•´ä¸ƒå¼µå¡ï¼Œæ›å–ä¸€æ¯é£²å“å—ï¼Ÿ`;}

  modal.style.display="flex";
}
function closeRedeem(){document.getElementById("redeemModal").style.display="none"; redeemTarget=null;}
function confirmRedeem(event){
  event.stopPropagation();
  if(!redeemTarget) return;
  let data=getDrawData();

  if(redeemTarget.type==="single"){
    const index=data.cards.indexOf(redeemTarget.target);
    if(index!==-1) data.cards.splice(index,1);
    alert("å…Œæ›æˆåŠŸï¼è«‹åˆ°æ«ƒå°é ˜å–å„ªæƒ  ğŸ‰");
  } else if(redeemTarget.type==="group"){
    cardImages.forEach(img=>{const idx=data.cards.indexOf(img); if(idx!==-1) data.cards.splice(idx,1);});
    alert("å…Œæ›æˆåŠŸï¼è«‹åˆ°æ«ƒå°é ˜å–å…è²»é£²å“ ğŸ¹");
  }

  saveDrawData(data);
  closeRedeem();
  showMyCards();
}

/* ================= æ‰‹æ–åµæ¸¬ ================== */
let lastTime=0;
let lastX=null,lastY=null,lastZ=null;

document.getElementById("enableShake").addEventListener("click", async function(){
  try{
    if(typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function"){
      const response=await DeviceMotionEvent.requestPermission();
      if(response!=="granted"){ alert("éœ€è¦å…è¨±å‹•ä½œæ„Ÿæ¸¬å™¨æ‰èƒ½ä½¿ç”¨æ–ä¸€æ–æŠ½å¡ï¼"); return; }
    }
    this.style.display="none";
    initShakeDetection();
    alert("âœ… æ–ä¸€æ–æŠ½å¡å·²å•Ÿç”¨ï¼æ‹¿èµ·æ‰‹æ©Ÿæ–ä¸€æ–è©¦è©¦ï½");
  }catch(e){ console.error(e); alert("è£ç½®ä¸æ”¯æ´æˆ–æ¬Šé™è¢«æ‹’çµ•"); }
});

function initShakeDetection(){
  window.addEventListener("devicemotion",function(event){
    const accel=event.accelerationIncludingGravity;
    if(!accel) return;

    const curTime=new Date().getTime();
    if((curTime-lastTime)>100){
      const diffTime=curTime-lastTime;
      lastTime=curTime;

      let x=accel.x, y=accel.y, z=accel.z;
      if(lastX!==null){
        let speed=Math.abs(x+y+z-lastX-lastY-lastZ)/diffTime*10000;
        if(speed>2000){ startDraw(); }
      }
      lastX=x; lastY=y; lastZ=z;
    }
  },false);
}
</script>
</body>
</html>
