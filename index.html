<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>3D æŠ½å¡ Demo - é‡æ§‹ç‰ˆ</title>
<style>
html, body {
  margin:0;
  padding:0;
  height:100%;
  font-family:Arial,sans-serif;
  overflow:hidden;
  background:#111;}

#mobileScreen{
  width:100vw;
  height:calc(var(--vh,1vh)*100);
  background:url('13.jpg') no-repeat center center;
  background-size:cover;
  position:relative;
  overflow:hidden;
padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  box-sizing: border-box;}

#cardContainer{
  width:100%;
  height:100%;
  perspective:1000px;
  position:relative;}

.cardGroup{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) rotateY(0deg);
  transform-style:preserve-3d;
  will-change:transform;}

.card{
  width:20vw;
  height:calc(20vw*800/600);
  position:absolute;
  top:50%;
  left:50%;
  background-size:cover;
  background-position:center;
  border-radius:12px;
  transform-style:preserve-3d;
  transition:opacity 1s, transform 1s;
  background-color:red;}

.centerCard{
  width:80vw;
  height:calc(80vw*800/600);
  position:absolute;
  top:50%;
  left:50%;
  background-size:cover;
  background-position:center;
  border-radius:16px;
  box-shadow:0 0 25px gold,0 0 50px yellow;
  z-index:10;
  opacity:0;
  transform:translate(-50%,-50%) scale(0.5);
  transition:opacity 1s, transform 1s;}

.centerCard.show{
  opacity:1;
  transform:translate(-50%,-50%) scale(1);}

.star{
  position:absolute;
  width:20px;
  height:20px;
  background:white;
  border-radius:50%;
  pointer-events:none;
  animation:flyStar 1.8s ease-out forwards;}

@keyframes flyStar{to{
  transform:translate(var(--x),var(--y)) scale(0);
  opacity:0;}}

.drawButton{
  position:absolute;
  left:52.04%;
  top:98%;
  transform:translate(-50%,-50%);
  width:71.29%;
  height:9.58%;
  background:transparent;
  border:none;
  cursor:pointer;
  z-index:9999;
top: auto;
  bottom: calc(5% + env(safe-area-inset-bottom));}

#overlay{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0);
  pointer-events:none;
  z-index:1;}

.cardGroup,.centerCard{
  position:absolute;
  z-index:10;}

.viewButton{
  position:absolute;
  bottom:2%;
  right:2%;
  padding:10px 15px;
  font-size:16px;
  border:none;
  background:rgba(255,215,0,0.8);
  color:black;
  border-radius:8px;
  cursor:pointer;
  z-index:9999;
bottom: calc(2% + env(safe-area-inset-bottom));
  right: calc(2% + env(safe-area-inset-right));}

#myCardsModal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.8);
  z-index:10000;
  color:white;
  overflow-y:auto;
  text-align:center;
  padding-top:50px;}

#myCardsContent{
  max-width:95%;
  margin:0 auto;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:20px;}

#myCardsContent img {
  width: 100%;        /* ä½”æ»¿å®¹å™¨ */
  max-width: 120px;   /* æœ€å¤§ 120px */
  border-radius: 8px;
  box-shadow: 0 0 10px gold;
  cursor: pointer;
}
.fullSetRow {
  display: flex;
  flex-wrap: wrap;       /* è¶…éå¯¬åº¦è‡ªå‹•æ›è¡Œ */
  justify-content: center;
  gap: 10px;
}

.fullSetRow img {
  flex: 0 0 calc(25% - 10px);  /* æ¡Œé¢ 4 å¼µ/è¡Œï¼Œæ‰‹æ©Ÿè‡ªå‹•æ›è¡Œ */
  max-width: 120px;
}
.zeroCards img { 
  flex: 1; 
  max-width: 120px; }

.close-button{
  position:absolute;
  top:15px;
  right:15px;
  width:40px;
  height:40px;
  background:rgba(255,255,255,0.2);
  border-radius:50%;
  border:none;
  color:white;
  font-size:24px;
  font-weight:bold;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10001;}

.close-button:hover{background:rgba(255,255,255,0.3);}

.fullSet{
  display:flex;
  flex-direction:column;
  gap:5px;}

.fullSetRow{
  display:flex;
  justify-content:center;
  gap:15px;}

.zeroCards{
  display:flex;
  flex-wrap:wrap;justify-content:center;
  gap:15px;}

#redeemModal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.7);
  z-index:20000;
  align-items:center;
  justify-content:center;}

#redeemModalContent{
  background:white;
  color:black;
  padding:20px;
  border-radius:12px;
  width:80%;
  max-width:400px;
  text-align:center;}

#redeemModalContent button{
  margin:10px;
  padding:10px 20px;
  font-size:18px;
  border:none;
  border-radius:8px;
  cursor:pointer;}

#confirmBtn{background:#ffcc00;}
#cancelBtn{background:#ccc;}
</style>
</head>
<body>
<div id="mobileScreen">
  <div id="cardContainer">
    <div class="cardGroup" id="cardGroup"></div>
    <div id="overlay"></div>
  </div>
  <button class="drawButton" onclick="startDraw()"></button>
  <button class="viewButton" onclick="showMyCards()">æŸ¥çœ‹æˆ‘çš„å¡ç‰‡</button>
</div>

<!-- æˆ‘çš„å¡ç‰‡æ¨¡æ…‹ -->
<div id="myCardsModal">
  <div id="myCardsContent">
    <button class="close-button" onclick="closeMyCardsModal()">Ã—</button>
  </div>
</div>

<!-- å…Œæ›æ¨¡æ…‹ -->
<div id="redeemModal">
  <div id="redeemModalContent">
    <p id="redeemText" style="font-size:20px;line-height:1.5;"></p>
    <button id="confirmBtn" onclick="confirmRedeem(event)">ç¢ºèªå…Œæ›</button>
    <button id="cancelBtn" onclick="closeRedeem()">å–æ¶ˆ</button>
  </div>
</div>

<script>
  
/* é«˜åº¦ä¿®æ­£ */
function setFullHeight(){document.documentElement.style.setProperty('--vh',window.innerHeight*0.01+'px');}
window.addEventListener('resize',setFullHeight); setFullHeight();

/* å¡ç‰‡è³‡æ–™ */
const backImage='9.jpg';
const cardImages=['1.jpg','22.jpg','3.jpg','4.jpg','21.jpg','20.jpg','23.jpg'];
const cardActivities={'1.jpg':'æŠ˜5å…ƒ','22.jpg':'æŠ˜10å…ƒ','3.jpg':'è²·ä¸€é€ä¸€','4.jpg':'æŠ˜8å…ƒ','21.jpg':'åŠ è³¼åŠåƒ¹','20.jpg':'æŠ˜3å…ƒ','23.jpg':'éš¨æ©Ÿå°ç¦®ç‰©'};
const maxDrawPerDay=100;

/* æŠ½å¡ç´€éŒ„ */
function getDrawData(){
  let data = JSON.parse(localStorage.getItem('drawData')) || {today:new Date().toISOString().split('T')[0],count:0,cards:[]};
  const today = new Date().toISOString().split('T')[0];
  if(data.today !== today){ data={today:today,count:0,cards:[]}; }
  return data;
}
function saveDrawData(data){localStorage.setItem('drawData',JSON.stringify(data));}
let rotateInterval = null;  // å…¨åŸŸå­˜æ”¾æ—‹è½‰å®šæ™‚å™¨
let centerCardTimeout = null;
let currentCenterCard = null;
/* æŠ½å¡å‹•ç•« */
function resetDraw() {
  // æ¸…æ‰æ—‹è½‰
  if (rotateInterval) { clearInterval(rotateInterval); rotateInterval = null; }
  // æ¸…æ‰ç­‰å¾…é¡¯ç¤ºä¸­å¿ƒå¡ç‰‡çš„ timeout
  if (centerCardTimeout) { clearTimeout(centerCardTimeout); centerCardTimeout = null; }
  // ç§»é™¤ä¸­å¿ƒå¡ç‰‡
  if (currentCenterCard) { currentCenterCard.remove(); currentCenterCard = null; }
  // æ¸…ç©ºå¡ç‰‡ç¾¤çµ„
  const group = document.getElementById("cardGroup");
  group.innerHTML = "";
  document.getElementById("overlay").style.background = "rgba(0,0,0,0)";
}

function startDraw() {
  resetDraw(); // ä¸­æ–·èˆŠå‹•ç•«

  const group = document.getElementById("cardGroup");
  const total = 6; 
  let cards = [];

  // ç”Ÿæˆå¡ç‰‡
  for (let i = 0; i < total; i++) {
    const card = document.createElement("div");
    card.className = "card";
    card.style.backgroundImage = `url('${backImage}')`;
    const angle = (i / total) * 360;
    card.style.transform = `translate(-50%,-50%) rotateY(${angle}deg) translateZ(30vw)`;
    group.appendChild(card);
    cards.push(card);
  }

  // é–‹å§‹æ—‹è½‰
  let rotation = 0;
  rotateInterval = setInterval(() => {
    rotation += 1;
    group.style.transform = `translate(-50%,-50%) rotateY(${rotation}deg)`;
  }, 20);

  // æŠ½å¡å»¶é²
  centerCardTimeout = setTimeout(() => {
    clearInterval(rotateInterval); rotateInterval = null;
    cards.forEach(c => c.style.opacity = 0);

    const chosenCard = cardImages[Math.floor(Math.random() * cardImages.length)];
    showCenterCard(chosenCard);

    let data = getDrawData();
    data.count++;
    data.cards.push(chosenCard);
    saveDrawData(data);
  }, 3000);
}


function showCenterCard(imageUrl) {
  const overlay = document.getElementById('overlay');
  overlay.style.background = 'rgba(0,0,0,0.4)';

  const container = document.getElementById("cardContainer");
  const centerCard = document.createElement("div");
  centerCard.className = "centerCard";
  centerCard.style.backgroundImage = `url('${imageUrl}')`;
  container.appendChild(centerCard);
  currentCenterCard = centerCard;

  requestAnimationFrame(() => centerCard.classList.add('show'));
  spawnStars(centerCard, 20);

  setTimeout(() => {
    overlay.style.background = 'rgba(0,0,0,0)';
    if (centerCard) { centerCard.remove(); currentCenterCard = null; }
  }, 5000);
}


function spawnStars(target,count){
  const rect=target.getBoundingClientRect();
  for(let i=0;i<count;i++){
    const star=document.createElement("div");
    star.className="star";
    star.style.left=`${rect.left+rect.width/2}px`;
    star.style.top=`${rect.top+rect.height/2}px`;
    const angle=Math.random()*2*Math.PI;
    const distance=80+Math.random()*100;
    star.style.setProperty("--x",`${Math.cos(angle)*distance}px`);
    star.style.setProperty("--y",`${Math.sin(angle)*distance}px`);
    document.body.appendChild(star);
    setTimeout(()=>star.remove(),1800);
  }
}

/* ===== æˆ‘çš„å¡ç‰‡æ¨¡æ…‹ ===== */
let redeemTarget = null;

function closeMyCardsModal(){document.getElementById('myCardsModal').style.display='none';}

function showMyCards(){
  const modal=document.getElementById('myCardsModal');
  const content=document.getElementById('myCardsContent');
  content.innerHTML=`<button class="close-button" onclick="closeMyCardsModal()">Ã—</button><h2>æˆ‘çš„å¡ç‰‡</h2>`;
  let data=getDrawData(); let myCards=[...data.cards];
  let groupCount=0;

  // å®Œæ•´ä¸ƒå¼µçµ„
  while(cardImages.every(img=>myCards.includes(img))){
    groupCount++;
    content.innerHTML+=`<h3>ç¬¬ ${groupCount} çµ„å®Œæ•´ä¸ƒå¼µ ğŸ‰</h3>`;
    let fullSetHTML=`<div class="fullSet"><div class="fullSetRow">`;
    for(let i=0;i<4;i++){ fullSetHTML+=`<img src="${cardImages[i]}" alt="å¡ç‰‡">`; myCards.splice(myCards.indexOf(cardImages[i]),1);}
    fullSetHTML+=`</div><div class="fullSetRow">`;
    for(let i=4;i<7;i++){ fullSetHTML+=`<img src="${cardImages[i]}" alt="å¡ç‰‡">`; myCards.splice(myCards.indexOf(cardImages[i]),1);}
    fullSetHTML+=`</div></div>`;
    content.innerHTML+=fullSetHTML;
    content.innerHTML+=`<div style="margin:15px;"><button onclick="event.stopPropagation(); openRedeemModal('group',${groupCount})" style="padding:10px 20px;font-size:18px;border:none;border-radius:8px;background:#ff6600;color:white;cursor:pointer;">å…Œæ›ä¸€æ¯é£²å“</button></div>`;
  }

  // é›¶æ•£å¡ç‰‡
  if(myCards.length>0){
    content.innerHTML+="<h3>é›¶æ•£å¡ç‰‡</h3>";
    let zeroHTML=`<div class="zeroCards">`;
    myCards.forEach(img=>{zeroHTML+=`<img src="${img}" alt="å¡ç‰‡" onclick="event.stopPropagation(); openRedeemModal('single','${img}')">`;});
    zeroHTML+=`</div>`;
    content.innerHTML+=zeroHTML;
  }

  modal.style.display='flex';
}

/* ===== çµ±ä¸€å…Œæ›æ¨¡æ…‹ ===== */
function openRedeemModal(type,target){
  redeemTarget={type,target};
  const modal=document.getElementById("redeemModal");
  const textEl=document.getElementById("redeemText");

  if(type==="single"){const activity=cardActivities[target]||"å…Œæ›æ´»å‹•"; textEl.innerText=`å¡ç‰‡æ´»å‹•ï¼š${activity}\nç¢ºèªå…Œæ›é€™å¼µå¡ç‰‡å—ï¼Ÿ`;}
  else if(type==="group"){textEl.innerText=`ç¢ºèªè¦å…Œæ›ç¬¬ ${target} çµ„å®Œæ•´ä¸ƒå¼µå¡ï¼Œæ›å–ä¸€æ¯é£²å“å—ï¼Ÿ`;}

  modal.style.display="flex";
}
function closeRedeem(){document.getElementById("redeemModal").style.display="none"; redeemTarget=null;}

function confirmRedeem(event){
  event.stopPropagation();
  if(!redeemTarget) return;
  let data=getDrawData();

  if(redeemTarget.type==="single"){
    const index=data.cards.indexOf(redeemTarget.target);
    if(index!==-1) data.cards.splice(index,1);
    alert("å…Œæ›æˆåŠŸï¼è«‹åˆ°æ«ƒå°é ˜å–å„ªæƒ  ğŸ‰");
  } else if(redeemTarget.type==="group"){
    cardImages.forEach(img=>{const idx=data.cards.indexOf(img); if(idx!==-1) data.cards.splice(idx,1);});
    alert("å…Œæ›æˆåŠŸï¼è«‹åˆ°æ«ƒå°é ˜å–å…è²»é£²å“ ğŸ¹");
  }

  saveDrawData(data);
  closeRedeem();
  showMyCards(); // é‡æ–°æ¸²æŸ“æˆ‘çš„å¡ç‰‡
}
</script>
</body>
</html>
